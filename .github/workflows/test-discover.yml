name: OVS Layer 2 Switch CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  prepare-vm:
    name: Prepare VM Image
    runs-on: ubuntu-latest
    env:
      IMAGE_URL: https://cloud.centos.org/centos/9-stream/x86_64/images/CentOS-Stream-GenericCloud-9-latest.x86_64.qcow2
    outputs:
      vm_image: ${{ steps.set-env.outputs.vm_image }}
      ssh_port: ${{ steps.set-env.outputs.ssh_port }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install qemu-img and curl
        run: sudo apt-get update && sudo apt-get install -y qemu-utils curl

      - name: Ensure vm-images directory exists
        run: mkdir -p vm-images

      - name: Cache base VM image
        id: cache-vm
        uses: actions/cache@v3
        with:
          path: vm-images/base.qcow2
          key: vm-image-base-${{ hashFiles('scripts/prepare-vm.sh') || '' }}
          restore-keys: |
            vm-image-base-

      - name: Download, verify, and prepare VM image
        id: set-env
        run: |
          set -e

          if [[ -z "$IMAGE_URL" ]]; then
              echo "❌ IMAGE_URL is not set"
              exit 1
          fi

          BASE_IMAGE="vm-images/base.qcow2"
          WORK_IMAGE="vm-images/test-$(basename "$IMAGE_URL" .qcow2)-$(date +%s).qcow2"

          # Download if cache is empty
          if [[ ! -f "$BASE_IMAGE" ]]; then
              echo "Downloading base VM image..."
              curl -L --fail -o "$BASE_IMAGE" "$IMAGE_URL"
          else
              echo "Using cached base image: $BASE_IMAGE"
          fi

          # Verify image
          echo "Verifying image..."
          qemu-img info "$BASE_IMAGE" || { echo "❌ Invalid image file"; exit 1; }

          # Copy and resize working image
          cp "$BASE_IMAGE" "$WORK_IMAGE"
          qemu-img resize "$WORK_IMAGE" 10G

          # Cleanup old working images, keep only latest 3
          echo "Cleaning up old VM images..."
          ls -1tr vm-images/test-*.qcow2 | head -n -3 | xargs -r rm -f || true

          # Set outputs and environment variables
          echo "VM_IMAGE=$WORK_IMAGE" >> $GITHUB_ENV
          SSH_PORT=$((2220 + RANDOM % 100))
          echo "SSH_PORT=$SSH_PORT" >> $GITHUB_ENV
          echo "vm_image=$WORK_IMAGE" >> $GITHUB_OUTPUT
          echo "ssh_port=$SSH_PORT" >> $GITHUB_OUTPUT

  run-tests:
    name: Run OVS Tests
    runs-on: ubuntu-latest
    needs: prepare-vm
    env:
      VM_IMAGE: ${{ needs.prepare-vm.outputs.vm_image }}
      SSH_PORT: ${{ needs.prepare-vm.outputs.ssh_port }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install qemu-img
        run: sudo apt-get update && sudo apt-get install -y qemu-utils

      - name: Display VM info
        run: |
          echo "✅ Using VM image: $VM_IMAGE"
          echo "SSH Port: $SSH_PORT"
          qemu-img info "$VM_IMAGE"

      - name: Run discovery and switch tests
        run: |
          set -e
          sudo bash ./scripts/test-discover-interfaces.sh
          sudo bash ./scripts/test-discover.yaml